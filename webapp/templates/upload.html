<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>

<div class="container">
    <h2 class="mt-5">Upload Video</h2>

    <form id="upload-form" action="/" method="post" enctype="multipart/form-data" class="mt-3">
        <div class="custom-file">
            <input type="file" name="video" id="video" class="custom-file-input">
            <label class="custom-file-label" for="video">Choose video</label>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Upload Video</button>
    </form>

    <div class="progress mt-3">
        <div id="upload-progress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <div class="video-container">
        <video id="video-player" controls style="width: 100%; height: auto;"></video>
        <canvas id="canvas" style="position: absolute; top: 0; left: 0;"></canvas>
    </div>

    <button id="draw-button" class="btn btn-secondary mt-3" style="display: none;">Draw Lines</button>
    <button id="process-button" class="btn btn-secondary mt-3" style="display: none;">Process Video</button>
    <div class="progress mt-3">
        <div id="processing-progress" class="progress-bar" role="progressbar" style="width:  0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div id="counts-graph"></div>
    <!-- Add this to your upload.html where you want to display the counts -->
    <div id="counts-display" style="margin-top:   20px;">
        <table id="counts-table" class="table">
            <thead>
                <tr>
                    <th>Line</th>
                    <th>Class</th>
                    <th>Direction</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody>
                <!-- Counts data will be inserted here -->
            </tbody>
        </table>
    </div>

</div>

<style>
    .video-container {
        position: relative;
        display: inline-block;
        width: 640px; /* Set to the width of your video */
        height: 480px; /* Set to the height of your video */
    }
    
    #video-player, #canvas {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
    }
    #counts-table {
        width:  100%;
        border-collapse: collapse;
    }
    #counts-table th, #counts-table td {
        border:  1px solid #ddd;
        padding:  8px;
        text-align: left;
    }
    #counts-table th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    #canvas + span {
        position: absolute;
        pointer-events: none;  /* Prevent the label from being interacted with */
        color: red;
        font-size:  12px;
        font-weight: bold;
    }
    .class-0 {
        background-color: #f2f2f2;
    }
    .class-1 {
        background-color: #e6ffe6;
    }
    .class-2 {
        background-color: #e6e6ff;
    }
    .class-3 {
        background-color: #ffffcc;
    }
    </style>

<script>
    $(document).ready(function(){
      var drawing = false;
      var lineStart = null;
    
      $('#video-player, #canvas').hide();
    
      $('.custom-file-input').on("change", function() {
        var fileName = $(this).val().split("\\").pop();
        $(this).siblings('.custom-file-label').addClass("selected").html(fileName);
      });
    
      $('#upload-form').on('submit', function(e) {
            e.preventDefault();

            var formData = new FormData(this);
            $.ajax({
                type: 'POST',
                url: '/',
                data: formData,
                contentType: false,
                processData: false,
                xhr: function() {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            var percent = Math.round((e.loaded / e.total) * 100);
                            $('#upload-progress').css('width', percent + '%').attr('aria-valuenow', percent);
                        }
                    });
                    return xhr;
                },
                success: function(response) {
                    $('#upload-progress').css('width', '100%').attr('aria-valuenow', 100);
                    alert(response.message);
                    $('#draw-button').show();
                    $('#process-button').show();  // Show the "Process Video" button
                    $('#video-player').attr('src', '/uploads/' + response.filename).css({width: '100%', height: '100%'}).prop('controls', true).on('loadedmetadata', function() {
                        var canvas = $('#canvas')[0];
                        var ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        $('#canvas').attr({width: this.clientWidth, height: this.clientHeight}).css('pointer-events', 'none').show();
                    }).show();
                }
            });
        });

        $('#draw-button').on('click', function() {
            console.log('Draw button clicked');
            drawing = !drawing;
            $('#video-player').prop('controls', !drawing);
            $('#canvas').css('pointer-events', drawing ? 'auto' : 'none');
            $(this).text(drawing ? 'Stop Drawing' : 'Draw Lines');
        });
        
        var labels = {};  // Create an object to store the labels
        $('#canvas').on('click', function(e) {
            if (drawing) {
                var rect = this.getBoundingClientRect();
                var x = e.clientX - rect.left;
                var y = e.clientY - rect.top;
                if (lineStart) {
                    var ctx = this.getContext('2d');
                    ctx.beginPath();
                    ctx.moveTo(lineStart.x, lineStart.y);
                    ctx.lineTo(x, y);
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 5;
                    ctx.stroke();
                    var video = document.getElementById('video-player');
                    var scaleX = video.videoWidth / video.clientWidth;
                    var scaleY = video.videoHeight / video.clientHeight;
                    $.post('/coordinates', {line: `(${Math.round(lineStart.x * scaleX)},${Math.round(lineStart.y * scaleY)}) (${Math.round(x * scaleX)},${Math.round(y * scaleY)})`}, function(response) {
                        // alert(response.message);
                    });
                    // Create a label element for the line
                    var label = document.createElement('span');
                    label.textContent = 'Line ' + Object.keys(labels).length;  // Use the number of lines as the label
                    label.style.position = 'absolute';
                    label.style.color = 'red';
                    label.style.fontSize = '15px';
                    label.style.fontWeight = 'bold';
                    label.style.pointerEvents = 'none';  // Prevent the label from being interacted with

                    var labelWidth = 50;
                    var labelHeight = 20;

                    // Calculate the angle of the line
                    var angle = Math.atan2(lineStart.y - y, x - lineStart.x);
                    // Determine the direction of the line and position the label accordingly
                    if (angle > -Math.PI /   4 && angle < Math.PI /   4) {
                        // Line is drawn from bottom left to upper right
                        label.style.left = (x - labelWidth) + 'px'; // Position to the left of the endpoint
                        label.style.top = y + 'px'; // Position above the endpoint
                    } else if (angle > Math.PI /   4 && angle <  3 * Math.PI /   4) {
                        // Line is drawn from bottom right to top left
                        label.style.left = (x +  10) + 'px'; // Position to the right of the endpoint
                        label.style.top = y + 'px';
                    } else if (angle >  3 * Math.PI /   4 && angle <  5 * Math.PI /   4) {
                        // Line is drawn from top left to bottom right
                        label.style.left = (x - labelWidth) + 'px'; // Position to the left of the endpoint
                        label.style.top = y + 'px';
                    } else {
                        // Line is drawn from top right to bottom left
                        label.style.left = (x +  10) + 'px'; // Position to the right of the endpoint
                        label.style.top = y + 'px';
                    }
                    document.querySelector('.video-container').appendChild(label);
                    labels[label.textContent] = label;  // Store the label in the labels object
                    lineStart = null;
                } else {
                    lineStart = {x: x, y: y};
                }
            }
        });
        
        console.log('JavaScript code run');  // Log when the JavaScript code is run

        $('#process-button').on('click', function() {
            var formData = new FormData(document.getElementById('upload-form'));
            var filename = formData.get('video').name;  // Get the filename from the form data
            fetch('/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({filename: filename})  // Pass the filename as JSON
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Video processing started:', data);
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
        });

        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on('progress', function(msg) {
            console.log('Processing progress:', msg);
            $('#processing-progress').css('width', msg.data + '%').attr('aria-valuenow', msg.data);
        });
        // Listen for the video_processed event
        socket.on('video_processed', function(msg) {
            console.log('Video processed event received:', msg);  // Log the event data

            // Make an AJAX request to get the counts data
            fetch('/counts/' + msg.filename)
                .then(response => response.json())
                // Inside the fetch success callback
                .then(data => {
                    // Parse the counts data into an array of objects
                    var lines = data.counts.split('\n\n');
                    var countsData = [];
                    var currentLine = 0;
                    var avgFPS;
                    lines.forEach(line => {
                        var parts = line.split('\n');
                        var lineName = parts[0];
                        console.log('Line:', lineName);
                        console.log('Parts:', parts);

                        parts.forEach(part => {
                            console.log('Part:', part);
                            var classParts = part.split(/[\s,]+/); // Split the part by spaces or commas
                            console.log('Class parts:', classParts);
                            if (classParts[0] === 'line') { // If the first part is 'line', set the current line
                                currentLine = classParts[1];
                            } else if (classParts[0] === 'Average' && classParts[1] === 'FPS:') {
                                avgFPS = classParts[2];
                            } else {
                                var classData = classParts[0].split('_') // Split the class name by underscores
                                countsData.push({
                                    line: 'Line ' + currentLine,
                                    class: classData[0],
                                    direction: classData[1],
                                    count: classParts[1]
                                });
                            }
                        });
                    })

                    // Create the data for the Plotly graph
                    var graphData = [];
                    countsData.forEach(count => {
                        // Find the trace for this class and direction, or create a new one if it doesn't exist
                        var trace = graphData.find(trace => trace.name === 'Class ' + count.class + ' ' + count.direction);
                        if (!trace) {
                            trace = {
                                x: [],
                                y: [],
                                type: 'bar',
                                name: 'Class ' + count.class + ' ' + count.direction
                            };
                            graphData.push(trace);
                        }

                        // Add the data for this count to the trace
                        trace.x.push(count.line);
                        trace.y.push(count.count);
                    });

                    // Create the layout for the Plotly graph
                    var layout = {
                        title: 'Counts by Line',
                        xaxis: {
                            title: 'Line'
                        },
                        yaxis: {
                            title: 'Count'
                        },
                        barmode: 'group'
                    };
                    
                    // Create the Plotly graph
                    Plotly.newPlot('counts-graph', graphData, layout);

                    // Get the table body element
                    var tableBody = document.getElementById('counts-display').querySelector('tbody');

                    // Clear the table body
                    tableBody.innerHTML = '';

                    // Insert each count as a row in the table
                    countsData.forEach(count => {
                        var row = document.createElement('tr');
                        var lineCell = document.createElement('td');
                        var classCell = document.createElement('td');
                        var directionCell = document.createElement('td');
                        var countCell = document.createElement('td');

                        lineCell.textContent = count.line;
                        classCell.textContent = count.class;
                        directionCell.textContent = count.direction;
                        countCell.textContent = count.count;

                        var className = 'class-' + count.class.replace(/\s+/g, '-');
                        row.classList.add(className);

                        row.appendChild(lineCell);
                        row.appendChild(classCell);
                        row.appendChild(directionCell);
                        row.appendChild(countCell);
                        tableBody.appendChild(row);
                    });

                    // Insert the average FPS into the table
                    if (avgFPS) {
                        var row = document.createElement('tr');
                        var cell = document.createElement('td');
                        cell.colSpan = 4;
                        cell.textContent = 'Average FPS: ' + avgFPS;
                        row.appendChild(cell);
                        tableBody.appendChild(row);
                    }
                })
                .catch(error => {
                    console.error('Error fetching counts data:', error);
                });
        });

    });
    </script>

</body>
</html>